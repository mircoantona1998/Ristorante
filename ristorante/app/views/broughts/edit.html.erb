<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Modifica Portata</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/5.3.0/css/bootstrap.min.css">
</head>
<script>
    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.form-check-input').forEach(function (checkbox) {
        const quantityField = document.getElementById('quantity_' + checkbox.value);
        
        quantityField.style.display = checkbox.checked ? 'block' : 'none';

        checkbox.addEventListener('change', function () {
          if (this.checked) {
            quantityField.style.display = 'block';   
            quantityField.querySelector('input').setAttribute('required', 'required');
          } else {
            quantityField.style.display = 'none';  
            quantityField.querySelector('input').removeAttribute('required'); 
          }
        });
      });

      document.querySelector('form').addEventListener('submit', function () {
        const priceInput = document.querySelector('input[name="brought[prezzo]"]');
        if (priceInput) {
          priceInput.value = priceInput.value.replace(',', '.');
        }

        document.querySelectorAll('input[name^="brought[ingredient_quantities]"]').forEach(function (input) {
          input.value = input.value.replace(',', '.'); 
        });
      });
    });
</script>
<body>

<div class="container">
  <h1>Modifica Portata</h1>

  <%= form_with model: @brought, local: true do |form| %>
    <div class="mb-3">
      <%= form.label :nome, class: 'form-label' %>
      <%= form.text_field :nome, class: 'form-control', required: true %>
    </div>

    <div class="mb-3">
      <%= form.label :prezzo, class: 'form-label' %>
      <%= form.number_field :prezzo, step: 0.01, class: 'form-control', required: true %>
    </div>

    <div class="mb-3">
      <%= label_tag :ingredient_ids, "Ingredienti", class: 'form-label' %>
      <div id="ingredients">
        <% @ingredients.each do |ingredient| %>
          <div class="form-check row mb-2">
            <div class="col-auto">
              <%= check_box_tag "brought[ingredient_ids][]", ingredient.id, @brought.ingredient_ids.include?(ingredient.id), id: "ingredient_#{ingredient.id}", class: 'form-check-input' %>
              <%= label_tag "ingredient_#{ingredient.id}", ingredient.nome, class: 'form-check-label' %>
            </div>
            <div class="col-auto quantity-input" id="quantity_<%= ingredient.id %>" style="display: none;">
              <%= text_field_tag "brought[ingredient_quantities][#{ingredient.id}]", 
                  @brought.ingredient_quantities[ingredient.id], 
                  placeholder: "QuantitÃ ", 
                  class: 'form-control d-inline', 
                  style: 'width: 80px;', 
                  min: '0' %>
              <span class="ms-2"><%= ingredient.unita_di_misura %></span>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <%= form.submit "Aggiorna Portata", class: 'btn btn-primary' %>
  <% end %>

  <div class="mt-3">
    <%= link_to 'Annulla', broughts_path, class: 'btn btn-secondary' %>
  </div>
  <%= link_to '<i class="fas fa-home"></i>'.html_safe, root_path, class: 'home-button' %>
</div>

</body>
</html>
